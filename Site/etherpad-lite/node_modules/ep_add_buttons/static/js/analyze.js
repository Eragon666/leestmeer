/*
 * Get the content from inside the text editor.
 */
function getPadContent(callback) {
	
	//Get the content frame
  	var contentFrame = $('[name="ace_outer"]').contents().find('[name="ace_inner"]');
	
	var content = contentFrame.contents().children().find('body#innerdocbody');
	
	var data = [];
	var paragraph = '';
	
	//Get all content divjes
	content.children('div').each(function () {		
		//Remove HTML tags
		var content = $(this).html().replace(/<\/?[^>]+(>|$)/g, "");
		
		//If line is empty, new paragraph starts
		if (content === '') {
			
			//Only add to array if paragraph is not empty
			if (paragraph !== '') {
				data.push(paragraph);
				paragraph = '';
			}
		} else {
			paragraph = paragraph + content;
		}
	});
	
	console.log(data);
	
	callback(data);
	
	
	
/* 	// Get the current url with the download link appended. Change txt to html or etherpad for other format
	var fullUrl = window.location.href + "/export/txt" ;
	
	// Make an ajax call to the link to get the current pad content
	jQuery.get(fullUrl, function(data) {
		var textContent = data;

		data = splitParagraphs(data);
		
		callback(data);
	});		 */
}


/*
 * analyze the data from inside the pad
 */
function analyzePadContent(type, callback) {
	
	getPadContent(function(data) {
		
		//countWords(data);
		//countSentences(data);
		
		sendParagraphs(data, type, function(analyzedData) {
			addScoreToSidebar(analyzedData);
			
			//Only update pad on the click of a button
			if (type === 'click') {
				updatePad(analyzedData);
			}
			
			countSentences(data);
		});
		
	});
	
}


/* 
 * split the paragraphs, and return them in an array. 
 */
function splitParagraphs(data) {
	// defined as a double newline
	data = data.split(/\n\n/);
	
	// IE support for filter is from IE9 on
	data = data.filter(function(e){ return e.replace(/(\r\n|\n|\r)/gm,"");});
	
	return data;
}


/*
 * Send the paragraphs via the websocket to python
 */
function sendParagraphs(data, type, callback) {
	
	var message = {
		info: {
			id: pad.getPadId(),
			corpusSet: $('#dropdown').val(),
			type: type
		},
		overall: [{
			clibScore: 10,
			ciltScore: 20,
			analytics: {
				words: 500,
				paragraphs: data.length,
				avgSentence: '5',				
				totalWords: '5'
			}
		}],
		text: []
	};
	
	// Add all paragraphs to object
	for (var i in data) {
		var tmp = {
			paragraph: data[i],
			analytics: {
				words: 500,
				avgSentence: '5',
				totalWords: '5'
			},
			changed: true
		};
		
		message.text.push(tmp);
		
	}
	
	var text = sendAnalyzeRequest(message, callback);
}


/*addClass
 * Add info to the sidebar
 */
function addScoreToSidebar(data) {
	
	var statistics = ['avi', 'clib', 'cilt'];
	
	//If the wrapper for the metrics already exists update the values, else update the scores.
	if ($('.metrics').length) {
		
		statistics.forEach(function(entry) {			
			var oldscore = $('.metrics-' + entry + 'score').html();
			var newscore = data.overall[0][entry + 'Score'];
			
			$('.metrics-' + entry + 'score').html(newscore);
			
			if (oldscore != newscore ) {
				
				$('.metrics-' + entry + 'score').toggleClass('metrics-score-update');
				
				setTimeout( function(){ 
					$('.metrics-' + entry + 'score').toggleClass('metrics-score-update');
				}  , 1000 );
			}
		});
		
	} else {
		
		var content = '<div class="metrics">' +
				'<table class="metrics-table">';
		
		statistics.forEach(function(entry) {
			content += '<tr class="metrics-row">' +
				'<td class="metrics-title metrics-' + entry + '">' + entry + '-Score</td>' +
				'<td class="metrics-score metrics-' + entry + 'score">' + data.overall[0][entry + 'Score'] + '</td>' +
			'</tr>';
		});
		
		content += '</table>' +
			'</div>';
		
		$('#sidebarInner').append(content);
		
	}
}


/*
 * Update the pad with feedback from the server
 */
function updatePad(data) {
	
	//var test = $('[name="ace_outer"]').find('.ace_inner');
	
	var fjq = $('[name="ace_outer"]').contents().find('[name="ace_inner"]')[0].contentWindow.$;
	
	
	//Get the content frame
  	var contentFrame = $('[name="ace_outer"]').contents().find('[name="ace_inner"]');
	
	var content = contentFrame.contents().children().find('body#innerdocbody');
	
	var children = content.children('div');
	var i = 0;
	var first = true;
	var last = false;
	var color = data.text[i].Colour;
	
	content.children('div').each(function () {		
		//Remove HTML tags
		var content = $(this).html().replace(/<\/?[^>]+(>|$)/g, "");
		
		//If line is empty, new paragraph starts
		if (content === '') {
			i++;
			first = true;
			if (data.text.hasOwnProperty(i)) {
				color = data.text[i].Colour;
			}
		} else {
			var style = {};
			
			//Get the content of the next div and check if its empty
			var next = $(this).next().html().replace(/<\/?[^>]+(>|$)/g, "");
			
			if (next === '') {
				last = true;
			}
			
			//Always add border sides to the div
			$(this).addClass('fb-box fb-box-sides');
			
			//Add the top border if its the first div of the paragraph
			if (first) {
				first = false;
				
/* 				$(this).addClass('fb-box-top'); */

			} else {
				$(this).addClass('fb-box-notoppadding');
			}
			
			//If this is the last div of the paragraph add a bottom
			if (last) {
				last = false;
				
/* 				$(this).addClass('fb-box-bottom'); */
			} else {
				$(this).addClass('fb-box-nobottompadding');
			}
			
			$(this).css('border-color', color);
			
			//Set the style to the pad
			//$(this).css(style);
		}
	});
	
/* 	for (var i in data.text) {
		console.log(data.text[i].paragraph);
		var color = data.text[i].paragraphColour;
		
		var end = false;
		
		console.log(typeof children);
		
	} */
	
}


function countWords(data) {
	
}

function countSentences(data) {
	
	
}